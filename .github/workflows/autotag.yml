name: Auto-create new tag

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "Dockerfile"

jobs:
  auto-tag:
    runs-on: ubuntu-latest
    steps:
      - name: ‚§µÔ∏è Check out code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_PAT }}

      - name: ‚§¥Ô∏è Get Tailscale version from Dockerfile
        id: get-tailscale-version
        run: |
          TAILSCALE_VERSION=$(cat Dockerfile \
            | awk -F: '{ print $2 }')
          echo "::set-output name=version::$TAILSCALE_VERSION"

      - name: üè∑ Create new tag
        run: |
          tag=${{ steps.get-tailscale-version.outputs.version }}
          message='${{ steps.get-tailscale-version.outputs.version }}: \
            PR #${{ github.event.pull_request.number }} \
            ${{ github.event.pull_request.title }}'
          git config user.name "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git tag -a "${tag}" -m "${message}"
          git push origin "${tag}"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
