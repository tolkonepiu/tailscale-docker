name: Auto-create new tag

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "Dockerfile"

jobs:
  auto-tag:
    runs-on: ubuntu-latest
    steps:
      - name: ‚§µÔ∏è Check out code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: ‚§¥Ô∏è Get Tailscale version from Dockerfile
        id: get-tailscale-version
        run: |
          TAILSCALE_VERSION=$(cat Dockerfile \
            | awk -F: '{ print $2 }')
          echo "::set-output name=version::$TAILSCALE_VERSION"

      - name: üè∑ Create new tag
        uses: actions-ecosystem/action-push-tag@v1
        with:
          tag: ${{ steps.get-tailscale-version.outputs.version }}
          message: "${{ steps.get-tailscale-version.outputs.version }}"
